<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Assistant</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: Arial, sans-serif;
        }

        .background {
            width: 100%;
            height: 100%;
            position: fixed;
            top: 0;
            left: 0;
            z-index: -1;
        }

        .background img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .menu {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(255, 255, 255, 0.8);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .menu p, .menu button {
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div id="background" class="background" onclick="toggleMenu()">
        <img id="statusGif" src="https://i.ibb.co/R9Lxd4W/Default-photo.jpg
" alt="Status">
    </div>
    <div id="menu" class="menu">
        <p>Email: support@example.com</p>
        <button onclick="sleepMode()">Sleep Mode</button>
        <button onclick="closeMenu()">Close</button>
    </div>

    <script src="https://code.responsivevoice.org/responsivevoice.js"></script>
    <script>
        let listeningForCommand = false;
let lastTranscript = '';
const wakeWord = "hey hub";
const recognition = new webkitSpeechRecognition();
const silenceDelay = 2500; // 2.5 seconds
let silenceTimer;
let messages = [];
const maxMessages = 8; // Maximum number of messages to keep

window.onload = function() {
    const savedMessages = localStorage.getItem('messages');
    if (savedMessages) {
        messages = JSON.parse(savedMessages);
    }
    setGif('https://i.ibb.co/R9Lxd4W/Default-photo.jpg'); // Set default GIF
};

recognition.continuous = true;
recognition.interimResults = true;
recognition.lang = 'en-US';

recognition.onresult = function(event) {
    clearTimeout(silenceTimer);

    const currentTranscript = Array.from(event.results)
                                   .map(result => result[0].transcript)
                                   .join('');

    if (!listeningForCommand && currentTranscript.toLowerCase().includes(wakeWord)) {
        listeningForCommand = true;
        lastTranscript = '';
        setGif('https://i.ibb.co/JkRhNz4/Listening.gif');
        addSystemMessage();
    } else if (listeningForCommand) {
        lastTranscript = currentTranscript;
        silenceTimer = setTimeout(() => {
            const commandAfterWakeWord = lastTranscript.substring(lastTranscript.toLowerCase().indexOf(wakeWord) + wakeWord.length).trim();
            if (commandAfterWakeWord) {
                setGif('https://i.ibb.co/0CV9sYB/Thinking.gif');
                sendCommandToAPI(commandAfterWakeWord);
            } else {
                setGif('https://i.ibb.co/Js4KZDw/Nothing-detected.gif');
            }
            listeningForCommand = false;
            recognition.stop(); // Stop recognition while processing the command
        }, silenceDelay);
    }
};

recognition.onerror = function(event) {
    if (event.error === 'no-speech') {
        setGif('https://i.ibb.co/dLKr4Mk/Error.gif');
        restartRecognition();
    }
};

recognition.start();

function addSystemMessage() {
    const today = new Date().toLocaleDateString();
    const systemMessage = `Today's date is ${today}. I am an AI assistant designed to respond to your voice commands.`;
    messages.push({ role: 'system', content: systemMessage });
    trimMessages();
}

function sendCommandToAPI(command) {
    console.log("Sending command to API:", command);
    messages.push({ role: 'user', content: command });
    trimMessages();

    fetch("https://api.deepinfra.com/v1/openai/chat/completions", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer HnO6SXFKeKem8tkzRo8f8LAbeWL42F6h" // Your API key
        },
        body: JSON.stringify({
            "model": "mistralai/Mistral-7B-Instruct-v0.1",
            "messages": messages
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        const reply = data.choices[0].message.content;
        console.log("API Response:", reply);
        messages.push({ role: 'assistant', content: reply });
        trimMessages();
        speakResponse(reply);
        saveMessages();
    })
    .catch(error => {
        console.error("API Error:", error.message);
        setGif('https://i.ibb.co/dLKr4Mk/Error.gif');
        document.getElementById('status').textContent = error.message;
    });
}

function trimMessages() {
    if (messages.length > maxMessages) {
        messages = messages.slice(-maxMessages); // Keep only the last 'maxMessages' messages
    }
}

function saveMessages() {
    localStorage.setItem('messages', JSON.stringify(messages));
}

function speakResponse(response) {
    console.log("Speaking:", response);
    setGif('https://i.ibb.co/ftsz0Xx/Responding.gif');
    responsiveVoice.speak(response, "UK English Male", {
        onend: function() {
            setGif('https://i.ibb.co/R9Lxd4W/Default-photo.jpg');
            recognition.start(); // Restart recognition after speaking
        }
    });
}

function setGif(gifPath) {
    document.getElementById('statusGif').src = gifPath;
}

function toggleMenu() {
    document.getElementById('menu').style.display = 'block';
}

function sleepMode() {
    setGif('https://i.ibb.co/sgZn6nz/IMG-6440.jpg');
    closeMenu();
}

function closeMenu() {
    document.getElementById('menu').style.display = 'none';
}

function restartRecognition() {
    recognition.stop();
    setTimeout(() => {
        recognition.start();
    }, 1000);
}
        function checkAndRestartRecognition() {
    if (!recognition || recognition.state !== 'running') {
        try {
            recognition.start();
        } catch (error) {
            console.error("Error restarting recognition:", error);
            setGif('https://i.ibb.co/dLKr4Mk/Error.gif'); // Show error GIF
        }
    }
}

// Set an interval to check recognition status every 5 seconds
setInterval(checkAndRestartRecognition, 5000);

    </script>
</body>
</html>
