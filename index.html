<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wake Word Detection</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 20px;
        }

        #status {
            color: green;
        }
    </style>
</head>
    <script src="https://code.responsivevoice.org/responsivevoice.js?key=74a2wYAJ"></script>
<body>
    <h1>Wake Word Detection Demo</h1>
    <p id="status">Listening for the wake word...</p>

    <script>
        let listeningForCommand = false;
        let lastTranscript = '';
        const wakeWord = "hey hub";
        const recognition = new webkitSpeechRecognition();
        const silenceDelay = 2000; // 2 seconds
        let silenceTimer;
        let messages = [];
        const maxMessages = 8; // Maximum number of messages to keep

        window.onload = function() {
            const savedMessages = localStorage.getItem('messages');
            if (savedMessages) {
                messages = JSON.parse(savedMessages);
            }
        };

        recognition.continuous = true;
        recognition.interimResults = true;
        recognition.lang = 'en-US';

        recognition.onresult = function(event) {
            clearTimeout(silenceTimer);

            const currentTranscript = Array.from(event.results)
                                           .map(result => result[0].transcript)
                                           .join('');

            if (!listeningForCommand && currentTranscript.toLowerCase().includes(wakeWord)) {
                listeningForCommand = true;
                lastTranscript = '';
                document.getElementById('status').textContent = "Listening for command...";
                addSystemMessage();
            } else if (listeningForCommand) {
                lastTranscript = currentTranscript;
                silenceTimer = setTimeout(() => {
                    const commandAfterWakeWord = lastTranscript.substring(lastTranscript.toLowerCase().indexOf(wakeWord) + wakeWord.length).trim();
                    sendCommandToAPI(commandAfterWakeWord);
                    listeningForCommand = false;
                    recognition.stop(); // Stop recognition while processing the command
                }, silenceDelay);
            }
        };

        recognition.start();

        function addSystemMessage() {
            const today = new Date().toLocaleDateString();
            const systemMessage = `Today's date is ${today}. I am an AI assistant designed to respond to your voice commands.`;
            messages.push({ role: 'system', content: systemMessage });
            trimMessages();
        }

        function sendCommandToAPI(command) {
            console.log("Sending command to API:", command);
            messages.push({ role: 'user', content: command });
            trimMessages();

            fetch("https://api.deepinfra.com/v1/openai/chat/completions", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": "Bearer HnO6SXFKeKem8tkzRo8f8LAbeWL42F6h" // Your API key
                },
                body: JSON.stringify({
                    "model": "mistralai/Mistral-7B-Instruct-v0.1",
                    "messages": messages
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                const reply = data.choices[0].message.content;
                console.log("API Response:", reply);
                messages.push({ role: 'assistant', content: reply });
                trimMessages();
                speakResponse(reply);
                saveMessages();
            })
            .catch(error => console.error("API Error:", error.message));
        }

        function trimMessages() {
            if (messages.length > maxMessages) {
                messages = messages.slice(-maxMessages); // Keep only the last 'maxMessages' messages
            }
        }

        function saveMessages() {
            localStorage.setItem('messages', JSON.stringify(messages));
        }

        function speakResponse(response) {
    console.log("Speaking:", response);
    responsiveVoice.speak(response, "UK English Male", {
        onend: function() {
            recognition.start(); // Restart recognition after speaking
        }
    });
    document.getElementById('status').textContent = "Listening for the wake word...";
}

        recognition.onend = function() {
            if (!listeningForCommand) {
                recognition.start(); // Restart recognition if not actively listening for a command
            }
        };
    </script>
</body>
</html>
