<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Assistant</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: Arial, sans-serif;
        }

        .background {
            width: 100%;
            height: 100%;
            position: fixed;
            top: 0;
            left: 0;
            z-index: -1;
        }

        .background img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .menu {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(255, 255, 255, 0.8);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .menu p, .menu button {
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div id="background" class="background" onclick="toggleMenu()">
        <img id="statusGif" src="https://i.ibb.co/R9Lxd4W/Default-photo.jpg
" alt="Status">
    </div>
    <div id="menu" class="menu">
        <p>Email: support@example.com</p>
        <button onclick="sleepMode()">Sleep Mode</button>
        <button onclick="closeMenu()">Close</button>
    </div>

    <script src="https://code.responsivevoice.org/responsivevoice.js"></script>
    <script>
        let listeningForCommand = false;
let lastTranscript = '';
const wakeWord = "hey hub";
const recognition = new webkitSpeechRecognition();
const silenceDelay = 2000; // 2 seconds
let silenceTimer;
let messages = [];
const maxMessages = 8; // Maximum number of messages to keep
let checkRecognitionInterval;

window.onload = function() {
    const savedMessages = localStorage.getItem('messages');
    if (savedMessages) {
        messages = JSON.parse(savedMessages);
    }
    setGif('https://i.ibb.co/R9Lxd4W/Default-photo.jpg'); // Set default GIF
    startSpeechRecognition();
    checkRecognitionInterval = setInterval(checkSpeechRecognition, 3000);
};

function startSpeechRecognition() {
    recognition.continuous = true;
    recognition.interimResults = true;
    recognition.lang = 'en-US';
    recognition.start();
    recognition.onresult = handleSpeechResult;
    recognition.onerror = handleSpeechError;
}

function checkSpeechRecognition() {
    if (!recognition.continuous) {
        startSpeechRecognition();
    }
}

function handleSpeechResult(event) {
    const currentTranscript = Array.from(event.results)
                                   .map(result => result[0].transcript)
                                   .join('');

    if (currentTranscript.toLowerCase().includes(wakeWord)) {
        if (listeningForCommand) {
            window.speechSynthesis.cancel(); // Stop current speech synthesis
        }
        listeningForCommand = true;
        setGif('https://i.ibb.co/JkRhNz4/Listening.gif');
    }

    if (listeningForCommand) {
        clearTimeout(silenceTimer);
        silenceTimer = setTimeout(() => {
            processCommand(currentTranscript);
        }, silenceDelay);
    }
}

function processCommand(transcript) {
    const commandAfterWakeWord = transcript.substring(transcript.toLowerCase().indexOf(wakeWord) + wakeWord.length).trim();
    if (commandAfterWakeWord) {
        setGif('https://i.ibb.co/0CV9sYB/Thinking.gif');
        sendCommandToAPI(commandAfterWakeWord);
    } else {
        setGif('https://i.ibb.co/Js4KZDw/Nothing-detected.gif');
    }
    listeningForCommand = false;
    recognition.stop(); // Stop recognition while processing the command
}

function sendCommandToAPI(command) {
    console.log("Sending command to API:", command);
    messages.push({ role: 'user', content: command });
    trimMessages();

    fetch("https://api.deepinfra.com/v1/openai/chat/completions", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer HnO6SXFKeKem8tkzRo8f8LAbeWL42F6h" // Replace with your actual DeepInfra API key
        },
        body: JSON.stringify({
            "model": "mistralai/Mistral-7B-Instruct-v0.1",
            "messages": messages
        })
    })
    .then(response => response.json())
    .then(data => {
        const reply = data.choices[0].message.content;
        console.log("API Response:", reply);
        messages.push({ role: 'assistant', content: reply });
        trimMessages();
        speakResponse(reply);
        saveMessages();
    })
    .catch(error => {
        console.error("API Error:", error.message);
        setGif('https://i.ibb.co/dLKr4Mk/Error.gif');
    });
}

function speakResponse(response) {
    console.log("Speaking:", response);
    const utterance = new SpeechSynthesisUtterance(response);
    utterance.onend = function() {
        setGif('https://i.ibb.co/R9Lxd4W/Default-photo.jpg');
        recognition.start(); // Restart recognition after speaking
    };
    window.speechSynthesis.speak(utterance);
}

function handleSpeechError(event) {
    if (event.error === 'no-speech') {
        setGif('https://i.ibb.co/dLKr4Mk/Error.gif');
        startSpeechRecognition();
    }
}

function trimMessages() {
    if (messages.length > maxMessages) {
        messages = messages.slice(-maxMessages); // Keep only the last 'maxMessages' messages
    }
}

function saveMessages() {
    localStorage.setItem('messages', JSON.stringify(messages));
}

function setGif(gifPath) {
    document.getElementById('statusGif').src = gifPath;
}

function toggleMenu() {
    document.getElementById('menu').style.display = 'block';
}

function sleepMode() {
    setGif('https://i.ibb.co/sgZn6nz/IMG-6440.jpg');
    closeMenu();
}

function closeMenu() {
    document.getElementById('menu').style.display = 'none';
}

function restartRecognition() {
    recognition.stop();
    setTimeout(() => {
        recognition.start();
    }, 1000);
}


    </script>
</body>
</html>
