<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        body, html { margin: 0; height: 100%; font-family: Arial, sans-serif; background: black; color: white }
        #status-gif { width: 100%; height: auto; }
    </style>
</head>
<body>
    <img id="status-gif" src="bootup.gif" alt="Status">
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const statusGif = document.getElementById('status-gif');
            const systemMessage = { role: "system", content: "Your custom system message here" }; // System message
            let recognition;
            let isRecording = false;
            let wakeWordDetected = false;
            let speechAfterWakeWord = '';
            let silenceTimer;

            setTimeout(() => { changeGif('normal-state.gif'); }, 3000); // Bootup for 3 seconds

            function initializeSpeechRecognition() {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = true;
                recognition.lang = 'en-US';
                recognition.interimResults = true;
                recognition.onresult = handleRecognitionResult;
                recognition.onend = restartSpeechRecognition;
                recognition.start();
                resetSilenceTimer();
                console.log("Speech recognition initialized.");
            }

            function restartSpeechRecognition() {
                if (!wakeWordDetected) {
                    recognition.stop();
                    setTimeout(() => {
                        recognition.start();
                        console.log("Speech recognition restarted.");
                    }, 100); // Brief pause before restart
                    resetSilenceTimer();
                }
            }

            function handleRecognitionResult(event) {
                let currentTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    currentTranscript += event.results[i][0].transcript.trim().replace(/,/g, "");
                    if (event.results[i].isFinal) {
                        console.log("Heard:", currentTranscript);
                        resetSilenceTimer(); // Reset timer on any final speech detected

                        if (currentTranscript.toLowerCase().includes("hey hub")) {
                            wakeWordDetected = true;
                            isRecording = true;
                            changeGif('wake-word-detected.gif');
                            console.log("Wake word detected. Switching to listening mode.");
                            speechAfterWakeWord = currentTranscript.substring(currentTranscript.toLowerCase().indexOf("hey hub") + 7).trim();
                            continue; // Skip further processing in this iteration
                        }

                        if (wakeWordDetected) {
                            speechAfterWakeWord += ' ' + currentTranscript;
                            changeGif('word-spoken.gif');
                            setTimeout(() => {
                                if (isRecording) {
                                    sendInputToAPI(speechAfterWakeWord);
                                }
                            }, 2000); // Send input after 2 seconds of pause
                        }
                    }
                }
            }

            function sendInputToAPI(input) {
                isRecording = false;
                changeGif('sending-to-api.gif');
                console.log("Sending to API:", input);
                let token = localStorage.getItem('OPENAI_API_KEY') || 'YOUR_OPENAI_API_KEY'; // Replace with your API key
                fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ 
                        model: "gpt-3.5-turbo", 
                        messages: [systemMessage, { role: "user", content: input }] 
                    })
                })
                .then(response => response.json())
                .then(data => {
                    console.log("API response:", data.choices[0].message.content);
                    receiveAPIResponse(data.choices[0].message.content);
                })
                .catch(error => console.error('Error:', error));
            }

            function receiveAPIResponse(response) {
                changeGif('responding.gif');
                speak(response);
                resetState();
            }

            function speak(text) {
                console.log("Speaking:", text);
                const utterance = new SpeechSynthesisUtterance(text);
                window.speechSynthesis.speak(utterance);
            }

            function resetState() {
                wakeWordDetected = false;
                speechAfterWakeWord = '';
                setTimeout(() => {
                    changeGif('normal-state.gif');
                }, 5000); // Reset state after 5 seconds
            }

            function resetSilenceTimer() {
                clearTimeout(silenceTimer);
                silenceTimer = setTimeout(() => {
                    if (!isRecording) {
                        recognition.stop();
                        setTimeout(() => {
                            recognition.start();
                            changeGif('normal-state.gif');
                            console.log("No speech detected. Resetting.");
                        }, 100);
                    }
                }, 30000); // 30 seconds of silence
            }

            function changeGif(gifName) {
                statusGif.src = gifName;
                console.log("Gif changed to:", gifName);
            }

            initializeSpeechRecognition();
        });
    </script>
</body>
</html>
